<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P2P Chat WebRTC (‡πÅ‡∏¢‡∏Å‡∏ä‡πà‡∏≠‡∏á Offer/Answer)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 10px; background:#f0f2f5;}
    textarea { width: 100%; height: 80px; margin-bottom: 8px; resize: vertical; font-family: monospace; }
    button { margin: 5px 3px; padding: 6px 12px; }
    .readonly { background:#eee; }
    #chatBox { height: 200px; overflow-y: auto; background: white; padding: 10px; border: 1px solid #ccc; margin-bottom: 8px; }
    .message { padding:5px 8px; border-radius: 12px; margin-bottom: 6px; max-width: 80%; word-wrap: break-word; }
    .you { background: #dcf8c6; align-self: flex-end; margin-left: auto; }
    .friend { background: #fff; border: 1px solid #ccc; align-self: flex-start; margin-right: auto; }
    #chatContainer { display: flex; flex-direction: column; }
    #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.5s ease; pointer-events: none; }
    #qrcodeOffer, #qrcodeAnswer { margin: 10px 0; }
    #fileProgress, #recvProgress { width: 100%; height: 16px; margin: 4px 0; display: none; }
  </style>
</head>
<body>

  <h2>‡∏ù‡∏±‡πà‡∏á A (‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Offer)</h2>
  <button id="createOfferBtn">‚ûï Create Offer</button>
  <button id="copyOfferBtn">üìã Copy Offer</button>
  <textarea id="offer" readonly class="readonly" placeholder="Offer ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"></textarea>
  <div id="qrcodeOffer"></div>

  <hr />

  <h2>‡∏ù‡∏±‡πà‡∏á B (‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö Offer)</h2>
  <textarea id="offerInput" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Offer ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á A)"></textarea>
  <button id="createAnswerBtn">üîÅ Create Answer</button>

  <hr />

  <h2>Answer (‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ)</h2>
  <textarea id="answer" placeholder="‡∏ß‡∏≤‡∏á Answer ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠)"></textarea>
  <button id="pasteAnswerBtn">üìã Paste Answer</button>
  <button id="copyAnswerBtn">üìã Copy Answer</button>
  <div id="qrcodeAnswer"></div>

  <hr />

  <h2>‡πÅ‡∏ä‡∏ï (‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠)</h2>
  <div id="chatBox"></div>
  <input type="text" id="messageInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." />
  <button id="sendBtn">üì® ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
  <input type="file" id="fileInput" />
  <progress id="fileProgress" max="100" value="0"></progress>
  <progress id="recvProgress" max="100" value="0"></progress>

  <button id="clearHistoryBtn">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ï</button>

  <div id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script>
    // ==== ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢ ====
    const $ = id => document.getElementById(id);
    const showToast = (msg) => {
      const toast = $("toast");
      toast.textContent = msg;
      toast.style.opacity = "1";
      setTimeout(() => toast.style.opacity = "0", 3000);
    };

    // ==== ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ WebRTC ====
    let pc, dc;
    let receiveBuffer = [], receivedSize = 0, fileMeta = null;
    const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    const createPeer = () => {
      pc = new RTCPeerConnection(config);
      pc.onicecandidate = e => {
        if (!e.candidate) console.log("ICE gathering complete");
      };
      pc.ondatachannel = e => setupDataChannel(e.channel);
    };

    const setupDataChannel = (channel) => {
      dc = channel;
      dc.onopen = () => {
        showToast("üü¢ Connected");
      };
      dc.onmessage = handleMessage;
      dc.onclose = () => {
        showToast("üî¥ Disconnected");
      };
    };

    const waitICE = () => new Promise((res) => {
      if (pc.iceGatheringState === "complete") return res();
      pc.addEventListener("icegatheringstatechange", () => {
        if (pc.iceGatheringState === "complete") res();
      });
    });

    // ==== ‡∏™‡∏£‡πâ‡∏≤‡∏á Offer ‡∏ù‡∏±‡πà‡∏á A ====
    $("createOfferBtn").onclick = async () => {
      try {
        if (pc) { pc.close(); pc = null; dc = null; }
        createPeer();
        setupDataChannel(pc.createDataChannel("chat"));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await waitICE();

        $("offer").value = JSON.stringify(pc.localDescription);

        $("qrcodeOffer").innerHTML = "";
        new QRCode("qrcodeOffer", { text: $("offer").value, width: 200, height: 200 });

        showToast("üéÅ ‡∏™‡∏£‡πâ‡∏≤‡∏á Offer ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      } catch (e) {
        console.error(e);
        showToast("‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á Offer ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }
    };

    // ==== ‡∏™‡∏£‡πâ‡∏≤‡∏á Answer ‡∏ù‡∏±‡πà‡∏á B ====
    $("createAnswerBtn").onclick = async () => {
      const offerText = $("offerInput").value.trim();
      if (!offerText) {
        showToast("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á Offer ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Answer");
        return;
      }
      try {
        if (pc) { pc.close(); pc = null; dc = null; }
        createPeer();

        const offer = JSON.parse(offerText);
        await pc.setRemoteDescription(offer);

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        await waitICE();

        $("answer").value = JSON.stringify(pc.localDescription);

        $("qrcodeAnswer").innerHTML = "";
        new QRCode("qrcodeAnswer", { text: $("answer").value, width: 200, height: 200 });

        showToast("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Answer ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      } catch (e) {
        console.error(e);
        showToast("‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Offer ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      }
    };

    // ==== ‡∏ß‡∏≤‡∏á Answer ‡∏ù‡∏±‡πà‡∏á A ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ====
    $("answer").addEventListener("input", async () => {
      const answerText = $("answer").value.trim();
      if (!answerText) return;
      try {
        const answer = JSON.parse(answerText);
        if (pc && pc.signalingState !== "closed") {
          await pc.setRemoteDescription(answer);
          showToast("üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Answer ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        }
      } catch (e) {
        console.error(e);
      }
    });

    // ==== ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ====
    $("sendBtn").onclick = () => {
      const text = $("messageInput").value.trim();
      if (!text) return;
      if (!dc || dc.readyState !== "open") {
        showToast("‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
        return;
      }
      dc.send(JSON.stringify({ type: "text", data: text }));
      appendMessage(text, "you");
      $("messageInput").value = "";
    };

    // ==== ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ====
    const appendMessage = (msg, sender = "you") => {
      const div = document.createElement("div");
      div.className = "message " + sender;
      div.innerHTML = msg;
      $("chatBox").appendChild(div);
      $("chatBox").scrollTop = $("chatBox").scrollHeight;
      saveChat(sender, msg);
    };

    // ==== ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ï ====
    const saveChat = (sender, msg) => {
      const chat = JSON.parse(localStorage.getItem("chat") || "[]");
      chat.push({ sender, msg });
      localStorage.setItem("chat", JSON.stringify(chat));
    };

    const loadChat = () => {
      const chat = JSON.parse(localStorage.getItem("chat") || "[]");
      chat.forEach(m => appendMessage(m.msg, m.sender));
    };

    $("clearHistoryBtn").onclick = () => {
      localStorage.removeItem("chat");
      $("chatBox").innerHTML = "";
      showToast("üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ï‡πÅ‡∏•‡πâ‡∏ß");
    };

    // ==== ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å DataChannel ====
    const handleMessage = (e) => {
      if (typeof e.data === "string") {
        const msg = JSON.parse(e.data);
        if (msg.type === "text") {
          appendMessage(msg.data, "friend");
        } else if (msg.type === "file-meta") {
          fileMeta = msg.data;
          receiveBuffer = [];
          receivedSize = 0;
          $("recvProgress").max = fileMeta.size;
          $("recvProgress").value = 0;
          $("recvProgress").style.display = "block";
        }
      } else {
        // ‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô ArrayBuffer
        receiveBuffer.push(e.data);
        receivedSize += e.data.byteLength;
        $("recvProgress").value = receivedSize;
        if (receivedSize >= fileMeta.size) {
          const blob = new Blob(receiveBuffer);
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = fileMeta.name;
          a.textContent = `üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå: ${fileMeta.name}`;
          appendMessage(a.outerHTML, "friend");
          $("recvProgress").style.display = "none";
        }
      }
    };

    // ==== ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå ====
    $("fileInput").onchange = () => {
      const file = $("fileInput").files[0];
      if (!file) return;
      if (!dc || dc.readyState !== "open") {
        showToast("‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
        return;
      }

      dc.send(JSON.stringify({ type: "file-meta", data: { name: file.name, size: file.size } }));

      const chunkSize = 16384;
      let offset = 0;
      $("fileProgress").max = file.size;
      $("fileProgress").value = 0;
      $("fileProgress").style.display = "block";

      const reader = new FileReader();
      reader.onload = e => {
        dc.send(e.target.result);
        offset += e.target.result.byteLength;
        $("fileProgress").value = offset;
        if (offset < file.size) readSlice(offset);
        else {
          $("fileProgress").style.display = "none";
          appendMessage(`üìé ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå: ${file.name}`, "you");
          showToast("üì§ ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß");
        }
      };

      const readSlice = o => {
        const slice = file.slice(o, o + chunkSize);
        reader.readAsArrayBuffer(slice);
      };
      readSlice(0);
    };

    // ==== ‡∏õ‡∏∏‡πà‡∏° Copy/Paste ====
    $("copyOfferBtn").onclick = () => {
      navigator.clipboard.writeText($("offer").value).then(() => showToast("üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Offer ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"));
    };
    $("copyAnswerBtn").onclick = () => {
      navigator.clipboard.writeText($("answer").value).then(() => showToast("üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Answer ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"));
    };
    $("pasteAnswerBtn").onclick = async () => {
      try {
        const text = await navigator.clipboard.readText();
        $("answer").value = text;
        showToast("üìã ‡∏ß‡∏≤‡∏á Answer ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      } catch {
        showToast("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÑ‡∏î‡πâ");
      }
    };

    // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ä‡∏ï‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
    loadChat();

  </script>
</body>
</html>
